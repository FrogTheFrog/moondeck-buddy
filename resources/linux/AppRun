#! /usr/bin/env bash
set -e

HERE="$(readlink -f "$(dirname "$0")")"
HERE2="$(readlink -f "$(dirname "$ARGV0")")"

# Wayland plugin is not packaged, so defining this to get rid of the warning
export QT_QPA_PLATFORM=xcb

echo "1-1 $*"
echo "1-2 $@"
echo "1-3 $0"
echo "1-4 $HERE"
echo "1-5 $HERE2"

if [ "$1" = "--exec" ]; then
    BINARY_NAME="$2"
    if [ -e "$HERE/usr/bin/$BINARY_NAME" ] ; then
        exec "$HERE/usr/bin/$BINARY_NAME" "${@:3}"
    else
        echo "$BINARY_NAME does not exist!"
        exit 1
    fi
elif [ -n "$APPIMAGE" ] ; then
    BINARY_NAME=$(basename "$ARGV0")
    echo "2 $ARGV0"
    echo "3 $BINARY_NAME"
    if [ -e "$HERE/usr/bin/$BINARY_NAME" ] ; then
        # Replace the app image env with the symlink as it will be used
        # to create an autostart script
        if [ -x "$ARGV0" ]; then
            SYMLINK_PATH="$(realpath -s "$ARGV0")"
        else
            SYMLINK_PATH="$(realpath -s "$(command -v "$ARGV0")")"
        fi
        echo "4 $SYMLINK_PATH"
        APPIMAGE="$SYMLINK_PATH" exec "$HERE/usr/bin/$BINARY_NAME" "$@"
    else
        exec "$HERE/usr/bin/MoonDeckBuddy" "$@"
    fi
else
    exec "$HERE/usr/bin/MoonDeckBuddy" "$@"
fi